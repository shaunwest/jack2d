<!DOCTYPE html>
<html>
<head>
  <title>Platforming Demo</title>
  <script src="../bower-components/jquery/dist/jquery.min.js"></script>
  <script src="../js/jack2d.js"></script>
  <script src="../js/jack2d-platformer.js"></script>
  <script src="js/player.js"></script>
  <style>
    #animation { position: absolute; z-index:1; }
    #platform { position: absolute; background-color: green; }
    #debugContainer {top: 0; right: 0;}
    #colliderContainer {
      position: absolute;
      border: 1px solid black;
      left: 0;
      width: 400px;
      height: 400px;
    }
  </style>
  <script>
    var player;
    $(document).ready(function() {
      'use strict';

      var CELL_SIZE = 100,
        NUM_CELLS = 4,
        WORLD_SIZE = CELL_SIZE * NUM_CELLS;

      var $animation = $('#animation'),
        animationContext = $animation[0].getContext('2d'),
        Obj = jack2d('obj'),
        Input = jack2d('input'),
        FLiveElement = jack2d('LiveElementFactory'),
        FPlayer = jack2d('PlayerFactory'),
        Debug = jack2d('debug');

      player = FPlayer();

      var platform = FLiveElement('#platform', ['AABBObject']);
      platform.x = 100;
      platform.y = 150;
      platform.width = 150;
      platform.height = 50;

      var world = Obj.mixin(['collider', 'canvas']).
        el('#visualCollider').
        checkerBackground().
        setWorldBounds(WORLD_SIZE).
        addObjects(platform);

      Debug.
        el('#debugContainer').
        livePrint(function(print) {
          print('pos', 'Pos: ' + player.x + ', ' + player.y);
          print('ground', 'Gnd: ' + player.onGround);
          print('border', 'Bor: ' + player.borderCollisionBottom);
          print('object', 'Obj: ' + player.objectCollisionBottom);
          print('left', 'Lft: ' + player.left);
          print('vel', 'Vel: ' + player.velocityX.toFixed(2) + ', ' + player.velocityY.toFixed(2));
        });

      function idle(velocityX) {
        return (Math.abs(velocityX) < 30)
      }

      player.
        loadSpriteSheet('img/player48.png').
        setFrictionX(0.99).
        setMaxVelocityX(150).
        setMaxVelocityY(300).
        setAccelerationY(500).
        setWorld(world).
        when('objectCollisionBottom').
          set('onGround', true).
        when('borderCollisionBottom').
          set('onGround', true).
        whenNot('objectCollisionBottom').
          andNot('borderCollisionBottom').
          set('onGround', false).
        whenNot('onGround').
          call('playSequence', 1).
        when('left').
          and('onGround').
          set('velocityX', -100).
          call('playSequence', 2, 'left').
        when('right').
          and('onGround').
          set('velocityX', 100).
          call('playSequence', 2, 'right').
        when('velocityX', idle).
          and('onGround').
          call('playSequence', 0).
        when('up').
          and('onGround').
          set('velocityY', -250).
        action('left', {key: Input.LEFT}).
        action('right', {key: Input.RIGHT}).
        action('up', {key: Input.UP}).
        onAnimationFrame(function() {
          var frame = this.getCurrentFrame();
          if(frame) {
            animationContext.clearRect(0, 0, 48, 48);
            animationContext.drawImage(frame, 0, 0);
          }
        }).
        onFrame(function() {
          $animation.
            css('left', this.x - 16).
            css('top', this.y - 16);

          /*if(Math.abs(this.velocityX) < 30 && Math.abs(this.velocityY) === 0) {
            this.playSequence(0);
          }*/
        });
    });
  </script>
</head>
<body>
<div>
  <div id="debugContainer"></div>
  <div id="colliderContainer">
    <canvas id="visualCollider" width="400" height="400"></canvas>
    <canvas id="animation" width="48" height="48"></canvas>
    <div id="platform"></div>
  </div>
</div>
</body>
</html>