<!DOCTYPE html>
<html>
<head>
  <title>Platforming Demo</title>
  <script src="../bower-components/jquery/dist/jquery.min.js"></script>
  <script src="../js/jack2d.js"></script>
  <script src="../js/jack2d-platformer.js"></script>
  <style>
    #animation { position: absolute; z-index:1; }
    #platform { position: absolute; background-color: green; }
    #debugContainer {top: 0; right: 0;}
    #colliderContainer {
      position: absolute;
      border: 1px solid black;
      left: 0;
      width: 400px;
      height: 400px;
    }
  </style>
  <script>
    jack2d('Player', ['obj'], function(obj) {
      var Entity = obj.mixin([
        'platformer.PhysicsObject',
        'platformer.PhysicsInterface',
        'spriteAnimation',
        'AABBObject'
      ]);

      return obj.extend([Entity, 'ActionObject']);
    });

    jack2d('PlayerFactory', ['Factory', 'Player'], function(Factory, Player) {
      return function() {
        var newPlayer = Factory(Player);
        newPlayer.x = 150;
        newPlayer.y = 118;
        newPlayer.width = 16;
        newPlayer.height = 32;
        return newPlayer.init();
      };
    });

    $(document).ready(function() {
      'use strict';

      var CELL_SIZE = 100,
        NUM_CELLS = 4,
        WORLD_SIZE = CELL_SIZE * NUM_CELLS;

      var $animation = $('#animation'),
        animationContext = $animation[0].getContext('2d'),
        obj = jack2d('obj'),
        input = jack2d('input'),
        $el = jack2d('LiveElementFactory'),
        $Player = jack2d('PlayerFactory'),
        debug = jack2d('debug');

      var player = $Player();

      var platform = $el('#platform', obj.mixin(['AABBObject']));
      platform.x = 100;
      platform.y = 150;
      platform.width = 150;
      platform.height = 50;

      var world = obj.mixin(['collider', 'canvas']).
        el('#visualCollider').
        checkerBackground().
        setWorldBounds(WORLD_SIZE).
        addObjects(platform);

      var stats = debug.
        el('#debugContainer').
        livePrint(function(print) {
          print('pos', 'Pos: ' + player.x + ', ' + player.y);
          print('vel', 'Vel: ' + player.velocityX.toFixed(2) + ', ' + player.velocityY.toFixed(2));
        });

      player.
        loadSpriteSheet('img/player48.png').
        setFrictionX(0.99).
        //setAccelerationX(50).
        setMaxVelocityX(150).
        setMaxVelocityY(300).
        //setAccelerationY(500).
        collisions(world).
        action('left', {key: input.LEFT}, function() {
          this.
            playSequence(2, 'left').
            setVelocityX(-100);
        }).
        action('right', {key: input.RIGHT}, function() {
          this.
            playSequence(2, 'right').
            setVelocityX(100);
        }).
        action('up', {key: input.UP}, function() {
          this.
            setVelocityY(-250).
            playSequence(1);
            //setAccelerationY(500);
        }).
        onAnimationFrame(function() {
          var frame = this.getCurrentFrame();
          if(frame) {
            animationContext.clearRect(0, 0, 48, 48);
            animationContext.drawImage(frame, 0, 0);
          }
        }).
        onFrame(function() {
          $animation.
            css('left', this.x - 16).
            css('top', this.y - 16);

          if(Math.abs(this.velocityX) < 30) {
            this.playSequence(0);
          }
        });
    });
  </script>
</head>
<body>
<div>
  <div id="debugContainer"></div>
  <div id="colliderContainer">
    <canvas id="visualCollider" width="400" height="400"></canvas>
    <canvas id="animation" width="48" height="48"></canvas>
    <div id="platform"></div>
  </div>
</div>
</body>
</html>