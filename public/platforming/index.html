<!DOCTYPE html>
<html>
<head>
  <title>Platforming Demo</title>
  <script src="../bower-components/jquery/dist/jquery.min.js"></script>
  <script src="../js/jack2d.js"></script>
  <script src="../js/jack2d-platformer.js"></script>
  <script src="js/player.js"></script>
  <style>
    #animation { position: absolute; z-index:1; }
    #platform { position: absolute; background-color: green; }
    #colliderContainer {
      position: absolute;
      border: 1px solid black;
      margin: 10px;
      right: 0;
      width: 400px;
      height: 400px;
    }
    #debugContainer {
      position: absolute;
      font-family: courier, sans-serif;
      background-color: rgba(0,0,0,0.7);
      color: #ffffff;
      margin: 0;
      padding: 10px;
      z-index: 99999;
      border: 2px solid #222222;
    }
  </style>
  <script>
    var player;
    $(document).ready(function() {
      'use strict';
      //jack2d.log = false;
      var CELL_SIZE = 100,
        NUM_CELLS = 4,
        WORLD_SIZE = CELL_SIZE * NUM_CELLS;


      var $animation = $('#animation'),
        animationContext = $animation[0].getContext('2d'),
        Chrono = jack2d('chrono'),
        helper = jack2d('helper'),
        Obj = jack2d('obj'),
        Input = jack2d('input'),
        FLiveElement = jack2d('LiveElementFactory'),
        Player = jack2d('Player'),
        FPlayer = jack2d('PlayerFactory'),
        Debug = jack2d('debug');

      player = FPlayer();

      var platform = FLiveElement('#platform', ['AABBObject']);
      platform.x = 100;
      platform.y = 150;
      platform.width = 150;
      platform.height = 50;

      var world = Obj.mixin(['collider', 'canvas']).
        el('#visualCollider').
        checkerBackground().
        setWorldBounds(WORLD_SIZE).
        addObjects(platform);

      Debug.
        el('#debugContainer').
        livePrint(function() {
          this.
            print('fps', 'FPS: ' + Chrono.getFps()).
            printObject(player);
        });

      function idle(velocityX) {
        return (Math.abs(velocityX) < 30);
      }

      function movingLeft(velocityX) {
        return (velocityX <= -30);
      }

      function movingRight(velocityX) {
        return (velocityX >= 30);
      }

      player.
        loadSpriteSheet('img/miyamoto.png').
        actions(function() {
        }).
          action('left', {key: Input.LEFT}).
          action('right', {key: Input.RIGHT}).
          action('up', {key: Input.UP}).
          flow().
            when('left').
              set('velocityX', -100).
            when('right').
              set('velocityX', 100).
            when('up').and('canJump').
              set('velocityY', -250).
            done().

        physics(function() {
        }).
          setFrictionX(0.99).
          setMaxVelocityX(150).
          setMaxVelocityY(300).
          setAccelerationY(500).

        collisions(world, function() {
        }).
          flow().
            when('collisionBottom').
              set('onGround', true).
            when('onGround').andNot('up').
              set('canJump', true).
            whenNot('onGround').
              set('canJump', false).
            whenNot('collisionBottom').
              set('onGround', false).
            when('collisionLeft').
              set('velocityX', 0).
            when('collisionRight').
              set('velocityX', 0).
            done().

        animate().
          flow().
            when('velocityX', movingLeft).
              set('direction', 'left').
            when('velocityX', movingRight).
              set('direction', 'right').
            when('onGround').
              call('playSequence', Player.RUN).
            when('onGround').and('velocityX', idle).
              call('playSequence', Player.IDLE).
            whenNot('onGround').
              call('playSequence', Player.JUMP).
            done().
          onAnimationFrame(function() {
            var frame = this.getCurrentFrame();
            if(frame) {
              animationContext.clearRect(0, 0, 48, 48);
              animationContext.drawImage(frame, 0, 0);
            }
          }).

        onFrame(function() {
          $animation.
            css('left', this.x - 16).
            css('top', this.y - 16);
        }, 'visual-position');

    });
  </script>
</head>
<body>
<div>
  <div id="debugContainer"></div>
  <div id="colliderContainer">
    <canvas id="visualCollider" width="400" height="400"></canvas>
    <canvas id="animation" width="48" height="48"></canvas>
    <div id="platform"></div>
  </div>
</div>
</body>
</html>